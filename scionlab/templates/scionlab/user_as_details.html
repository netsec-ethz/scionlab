{% extends 'scionlab/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}User AS{% endblock %}

{% block content %}
<h3>AS {{object.as_id }}</h3>


{% crispy form %}

<button type="submit" form="id_user_as_form" class="btn btn-primary savebtn">Save Changes</button>
{% if object.is_active %}
  <a class="ml-3" href="{% url 'user_as_config' pk=object.pk %}"><span class="fa fa-download"></span> Download configuration</a>
  <button type="submit" form="id_deactivate_form" class="btn btn-outline-danger pull-right">Deactivate this AS</button>
  <form id="id_deactivate_form" method="post" action="{% url 'user_as_deactivate' pk=object.pk %}">{% csrf_token %}
</form>
{% else %}
  <button type="submit" form="id_activate_form" class="btn btn-success pull-right">Activate this AS</button>
  <form id="id_activate_form" method="post" action="{% url 'user_as_activate' pk=object.pk %}">{% csrf_token %}
  </form>
{% endif %}

{{ attachment_points|json_script:"attachment_points" }}

<script>
$(document).ready(function () {
  // Only enable save button when form is dirt:
  // Disable Save button on page load. Reset 
  $(".savebtn").attr('disabled', 'disabled');
  // Reset form to avoid stale dirty entries after page reload (firefox)
  $("#id_user_as_form").get(0).reset()
  // Enable Save button when any input field changes
  $(":input ").change(function(){
    $(".savebtn").removeAttr('disabled');
    window.onbeforeunload = function() { return ""; }
  });
  // When save button is clicked, don't show the navigate away warning
  $(".savebtn ").click(function(){
    window.onbeforeunload = null;
  });


  // Handle attachment point VPN availability:
  update_use_vpn_enable();
  $("#id_attachment_point").change(update_use_vpn_enable);
  $("#id_use_vpn").change(update_ip_fields_show);
});

var attachment_points = JSON.parse(document.getElementById('attachment_points').textContent);

function update_use_vpn_enable() {
  sel = document.getElementById('id_attachment_point');
  selected_ap = sel.options[sel.selectedIndex].value;
  has_vpn = attachment_points[selected_ap].has_vpn;

  toggle = $("#id_use_vpn");
  if(has_vpn){
    toggle.prop('disabled', false);
    toggle.prop('checked', toggle.prop('was-checked'));
    toggle.removeAttr('was-checked');
  } else {
    toggle.prop('was-checked', toggle.prop('checked'));
    toggle.prop('checked', false);
    toggle.prop('disabled', true);
  }
  update_ip_fields_show();
}

function update_ip_fields_show() {
  if($("#id_use_vpn").prop("checked")) {
    $("#div_id_public_ip").hide();
    $("#row_id_bind_addr").hide();
  } else {
    $("#div_id_public_ip").show();
    $("#row_id_bind_addr").show();
  }
}
</script>

{% endblock content %}
